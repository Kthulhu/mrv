#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""Prepares the nose test environment for use with mrv"""
import sys
import os

__docformat__ = "restructuredtext"

def _parse_args(args):
	"""Parse our arguments and react accordingly. 
	args don't contain the maya version number anymore, but may contain our 
	args interleaved with nose args
	
	:return: altered arguments to be passed to mrv"""
	# run nose, no matter what
	args = list(args)
	base = ['-c', 'import mrv.test.cmds.nosestartup']
	
	# HANDLE COVERAGE
	#################
	try:
		args.remove('--mrv-coverage')
		base += ['--with-coverage', '--cover-html', '--cover-package=mrv', '--cover-html-dir=coverage']
	except ValueError:
		pass
	# END coverage handling
	
	return tuple(base + args)

def tmrvmain(args):
	"""Launch mrv main with customized startup"""
	# we assume to be launched using a relative path 
	ospd = os.path.dirname
	# mrv/test/bin/tmrv -> mrv/bin/mrv
	mrvpath = os.path.join(ospd(ospd(ospd(os.path.realpath(os.path.abspath(__file__))))), 'bin', 'mrv')
	globals()['__name__'] = "prevent execution of main"
	# mrv assumes its being started from mrv/bin
	globals()['__file__'] = mrvpath
	
	try:
		fp = open(mrvpath)
		exec fp in globals()
		fp.close()
	except Exception, e:
		raise EnvironmentError("Could not execute mrv at %r with error %s" % (mrvpath, e))
	# END exception handling
	
	mrvmain(args, args_modifier=_parse_args)
	
	
if __name__ == "__main__":
	# ignore first arg which is the executable
	tmrvmain(sys.argv[1:])
# END initialization
